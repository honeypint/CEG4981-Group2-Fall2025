import tkinter as tk
from tkinter import filedialog                             #pop up window imports
import cv2
import os                                                #opencv imports
import numpy as np

root = tk.Tk()
root.withdraw()

file_paths = filedialog.askopenfilenames(               #prompts user to pick 10 deathstar images, and opens file explorer
        title="Select 10 deathstar images",
        filetypes=[("Image Files", "*.jpg *.jpeg *.png *.bmp *.gif")]   
)

if file_paths:                                  
    selected_images = file_paths[:10]           

    save_folder = filedialog.askdirectory(title="Select a folder to save images")       #prompts for user to pick a folder to save too

    if save_folder:
        for i, file_path in enumerate(selected_images):
            img = cv2.imread(file_path)

            if img is not None:
                
                hsv = cv2.cvtColor(img, cv2.COLOR_BGR2HSV)                  #Changes to hsv color pallete

                lower_red1 = np.array([0, 100, 100])
                upper_red1 = np.array([10, 255, 255])
                lower_red2 = np.array([170, 100, 100])
                upper_red2 = np.array([180, 255, 255])                  #Sets what color red to look for

                mask1 = cv2.inRange(hsv, lower_red1, upper_red1)
                mask2 = cv2.inRange(hsv, lower_red2, upper_red2)        #mask for red arrays
                red_mask = cv2.bitwise_or(mask1, mask2)

                gray = cv2.GaussianBlur(red_mask, (9, 9), 2)

                circles = cv2.HoughCircles(
                    gray, cv2.HOUGH_GRADIENT, dp=1.0, minDist=50,
                    param1=100, param2=15, minRadius=10, maxRadius=0
                )
                
                if circles is not None:
                    circles = np.round(circles[0, :]).astype("int")
                    for j, (x, y, r) in enumerate(circles):

                        mask = np.zeros_like(gray)
                        cv2.circle(mask, (x, y), r, 255, -1)

                        masked_img = cv2.bitwise_and(img, img, mask=mask)

                        x1, y1 = max(0, x-r), max(0, y-r)
                        x2, y2 = min(img.shape[1], x+r), min(img.shape[0], y+r)         #cropping around red circle
                        cropped = masked_img[y1:y2, x1:x2]

                        save_path = os.path.join(save_folder, f"cropped{i+1}.png")       #saving cropped image with new name
                        cv2.imwrite(save_path, cropped)
                else:
                    print(f"[WARN] No red circles found in {file_path}")                #debug log


